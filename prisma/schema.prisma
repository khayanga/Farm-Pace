generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  
}

model User {
  user_id               String           @id @default(uuid())
  name                  String?
  email                 String           @unique
  password              String?
  role                  Role             @default(admin)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  forcePasswordReset    Boolean          @default(true)
  cropLogs              CropLog[]
  farms                 FarmUser[]
  recurringTasksCreated RecurringTask[]  @relation("RecurringTasksCreatedBy")
  tasksCreated          Task[]           @relation("TasksCreatedBy")
  taskAssignments       TaskAssignment[]
  taskNotes             TaskNote[]
}

model Farm {
  id             String          @id @default(uuid())
  name           String
  location       String?
  gps            String?
  code           String          @unique
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  farmNumber     Int             @unique @default(autoincrement())
  templates      CropTemplate[]  @relation("FarmToTemplate")
  crops          FarmCrop[]
  users          FarmUser[]
  offtakers      Offtaker[]
  recurringTasks RecurringTask[]
  sensors        Sensor[]
  sensorData     SensorData[]
  tasks          Task[]
  vendors        Vendor[]
  weatherData    WeatherData[]
}

model FarmUser {
  id      Int    @id @default(autoincrement())
  user_id String
  farm_id String
  role    Role
  farm    Farm   @relation(fields: [farm_id], references: [id])
  user    User   @relation(fields: [user_id], references: [user_id])
}

model Crop {
  id       Int       @id @default(autoincrement())
  name     String
  category String?
  phiData  PHIData[]
}

model CropTemplate {
  id        Int        @id @default(autoincrement())
  name      String
  farm_id   String
  category  String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  farm      Farm       @relation("FarmToTemplate", fields: [farm_id], references: [id])
  farmCrops FarmCrop[]
}

model FarmCrop {
  id             Int             @id @default(autoincrement())
  farm_id        String
  variety        String
  plantedAt      DateTime        @default(now())
  seedlings      Int?
  template_id    Int
  logs           CropLog[]
  farm           Farm            @relation(fields: [farm_id], references: [id])
  template       CropTemplate    @relation(fields: [template_id], references: [id])
  harvests       Harvest[]
  recurringTasks RecurringTask[]
  sensors        SensorData[]
  tasks          Task[]
}

model CropLog {
  id          Int      @id @default(autoincrement())
  farmCrop_id Int
  logType     String
  description String?
  quantity    Float?
  unit        String?
  createdBy   String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [createdBy], references: [user_id])
  farmCrop    FarmCrop @relation(fields: [farmCrop_id], references: [id])
}

model Harvest {
  id          Int      @id @default(autoincrement())
  farmCrop_id Int
  grade1      Float?
  grade2      Float?
  grade3      Float?
  date        DateTime @default(now())
  farmCrop    FarmCrop @relation(fields: [farmCrop_id], references: [id])
}

model PHIData {
  id       Int    @id @default(autoincrement())
  crop_id  Int
  chemical String
  phiDays  Int
  crop     Crop   @relation(fields: [crop_id], references: [id])
}

model Vendor {
  id      Int    @id @default(autoincrement())
  farm_id String
  name    String
  type    String
  farm    Farm   @relation(fields: [farm_id], references: [id])
}

model Offtaker {
  id      Int     @id @default(autoincrement())
  farm_id String
  name    String
  contact String?
  farm    Farm    @relation(fields: [farm_id], references: [id])
}

model SensorData {
  id         Int          @id @default(autoincrement())
  farm_id    String
  crop_id    Int?
  metric     SensorMetric
  value      Float
  unit       String?
  recordedAt DateTime     @default(now())
  sensor_id  Int?
  crop       FarmCrop?    @relation(fields: [crop_id], references: [id])
  farm       Farm         @relation(fields: [farm_id], references: [id])
  sensor     Sensor?      @relation("SensorReadings", fields: [sensor_id], references: [id])
}

model Sensor {
  id          Int          @id @default(autoincrement())
  code        String       @unique
  farm_id     String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  farm        Farm         @relation(fields: [farm_id], references: [id])
  readings    SensorData[] @relation("SensorReadings")
}

model Task {
  id          Int              @id @default(autoincrement())
  farm_id     String
  farmCrop_id Int?
  title       String
  description String?
  taskType    TaskType
  color       String
  startDate   DateTime
  endDate     DateTime?
  recurrence  String?
  createdBy   String
  status      TaskStatus       @default(pending)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  creator     User             @relation("TasksCreatedBy", fields: [createdBy], references: [user_id])
  farmCrop    FarmCrop?        @relation(fields: [farmCrop_id], references: [id])
  farm        Farm             @relation(fields: [farm_id], references: [id])
  assignedTo  TaskAssignment[]
  notes       TaskNote[]
}

model TaskAssignment {
  id      Int    @id @default(autoincrement())
  task_id Int
  user_id String
  task    Task   @relation(fields: [task_id], references: [id])
  user    User   @relation(fields: [user_id], references: [user_id])
}

model TaskNote {
  id        Int      @id @default(autoincrement())
  task_id   Int
  user_id   String
  note      String?
  imageUrl  String?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [task_id], references: [id])
  user      User     @relation(fields: [user_id], references: [user_id])
}

model WeatherData {
  id           Int      @id @default(autoincrement())
  farm_id      String
  temperature  Float?
  humidity     Float?
  soilMoisture Float?
  recordedAt   DateTime @default(now())
  rainfall     Float?
  temp_max     Float?
  temp_min     Float?
  farm         Farm     @relation(fields: [farm_id], references: [id])

  @@index([farm_id, recordedAt])
}

model RecurringTask {
  id          Int                      @id @default(autoincrement())
  farm_id     String
  farmCrop_id Int?
  title       String
  description String?
  taskType    TaskType
  color       String?
  frequency   RecurrenceFrequency
  interval    Int                      @default(1)
  startDate   DateTime
  time        String
  endDate     DateTime?
  createdBy   String
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  creator     User                     @relation("RecurringTasksCreatedBy", fields: [createdBy], references: [user_id])
  farmCrop    FarmCrop?                @relation(fields: [farmCrop_id], references: [id])
  farm        Farm                     @relation(fields: [farm_id], references: [id])
  exceptions  RecurringTaskException[]
}

model RecurringTaskException {
  id               Int           @id @default(autoincrement())
  recurringTask_id Int
  date             DateTime
  isSkipped        Boolean       @default(false)
  modifiedTitle    String?
  modifiedTime     String?
  modifiedDate     DateTime?
  recurringTask    RecurringTask @relation(fields: [recurringTask_id], references: [id])
}

enum TaskType {
  fertilizer
  foliar_fertilizer
  pesticide
  fungicide
  irrigation
  harvesting
}

enum TaskStatus {
  pending
  completed
  skipped
  in_progress
}

enum Role {
  farmer
  admin
  engineer
  agronomist
  marketer
}

enum SensorMetric {
  temperature_day
  temperature_night
  humidity
  soil_moisture
  soil_ph
  co2
}

enum RecurrenceFrequency {
  daily
  weekly
  monthly
  yearly
  custom
}
